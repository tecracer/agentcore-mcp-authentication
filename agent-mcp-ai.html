<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>agent-mcp-ai</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css" />
</head>
<body>
<h1
id="mcp-design-and-authentication-for-agent-connections-a-complete-guide">MCP
Design and Authentication for Agent Connections: A Complete Guide</h1>
<p>The initial challenge is that AgentCore is a relatively new service,
still in preview, with sparse documentation. Nevertheless, some
components are already available and working well.</p>
<h2 id="setting-up-basic-agents">Setting Up Basic Agents</h2>
<p>Setting up agents is quite straightforward with the new AWS Starter
toolkit available at <a
href="https://github.com/aws/bedrock-agentcore-starter-toolkit">https://github.com/aws/bedrock-agentcore-starter-toolkit</a>.
The commands <code>agentcore configure</code>,
<code>agentcore launch</code>, <code>agentcore invoke</code> (along with
<code>agentcore monitor</code> and <code>agentcore destroy</code>) make
it incredibly easy to create and manage agents.</p>
<p>Here’s a basic agent implementation:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> strands <span class="im">import</span> Agent, tool</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bedrock_agentcore.runtime <span class="im">import</span> BedrockAgentCoreApp</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> strands.models <span class="im">import</span> BedrockModel</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> BedrockAgentCoreApp()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">@tool</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> your_tool(<span class="bu">input</span>: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Your calculator tool implementation&quot;&quot;&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;result&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>agent <span class="op">=</span> Agent(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>BedrockModel(model_id<span class="op">=</span><span class="st">&quot;eu.anthropic.claude-3-7-sonnet-20250219-v1:0&quot;</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    tools<span class="op">=</span>[calculator],</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span><span class="st">&quot;You&#39;re a helpful assistant. You can do simple math calculations.&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="at">@app.entrypoint</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strands_agent_bedrock(payload):</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    user_input <span class="op">=</span> payload.get(<span class="st">&quot;input&quot;</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> agent(user_input)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.message[<span class="st">&#39;content&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;text&#39;</span>]</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    app.run()</span></code></pre></div>
<p>Deployment is straightforward:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure the agent</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> configure <span class="at">-e</span> single_strands_agent.py <span class="at">-n</span> single_strands_agent</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to cloud</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> launch</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the deployed agent</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> invoke <span class="st">&#39;{&quot;input&quot;: &quot;What is 2+2?&quot;}&#39;</span></span></code></pre></div>
<h2 id="setting-up-mcp-servers">Setting Up MCP Servers</h2>
<p>I set up my first MCP server following the <a
href="https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-mcp.html">official
AWS documentation</a>. The implementation uses FastMCP and follows the
recommended structure:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mcp.server.fastmcp <span class="im">import</span> FastMCP</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> starlette.responses <span class="im">import</span> JSONResponse</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mcp <span class="op">=</span> FastMCP(host<span class="op">=</span><span class="st">&quot;0.0.0.0&quot;</span>, stateless_http<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">@mcp.tool</span>()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_numbers(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>   <span class="co">&quot;&quot;&quot;Add two numbers together&quot;&quot;&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> a <span class="op">+</span> b</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="at">@mcp.tool</span>()</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiply_numbers(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>   <span class="co">&quot;&quot;&quot;Multiply two numbers together&quot;&quot;&quot;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> a <span class="op">*</span> b</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="at">@mcp.tool</span>()</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greet_user(name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>   <span class="co">&quot;&quot;&quot;Greet a user by name&quot;&quot;&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="ss">f&quot;Hello, </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">! Nice to meet you.&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>   mcp.run(transport<span class="op">=</span><span class="st">&quot;streamable-http&quot;</span>)</span></code></pre></div>
<h3 id="aws-documentation-approach-for-mcp-configuration">AWS
Documentation Approach for MCP Configuration</h3>
<p>The <a
href="https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-mcp.html#runtime-mcp-appendix-a">AWS
documentation</a> provides a straightforward approach for MCP
configuration. It includes a complete script that:</p>
<ol type="1">
<li><strong>Creates a Cognito User Pool</strong> with a user
account</li>
<li><strong>Generates the Discovery URL</strong> for OAuth2
configuration</li>
<li><strong>Provides the Client ID</strong> needed for MCP setup</li>
<li><strong>Creates a Bearer Token</strong> for direct
authentication</li>
</ol>
<p>Here’s the key part of their setup script:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create User Pool and capture Pool ID directly</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">POOL_ID</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> cognito-idp create-user-pool <span class="dt">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--pool-name</span> <span class="st">&quot;MyUserPool&quot;</span> <span class="dt">\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--policies</span> <span class="st">&#39;{&quot;PasswordPolicy&quot;:{&quot;MinimumLength&quot;:8}}&#39;</span> <span class="dt">\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span> us-central-1 <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.UserPool.Id&#39;</span><span class="va">)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create App Client and capture Client ID directly</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CLIENT_ID</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> cognito-idp create-user-pool-client <span class="dt">\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--user-pool-id</span> <span class="va">$POOL_ID</span> <span class="dt">\</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--client-name</span> <span class="st">&quot;MyClient&quot;</span> <span class="dt">\</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">--no-generate-secret</span> <span class="dt">\</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">--explicit-auth-flows</span> <span class="st">&quot;ALLOW_USER_PASSWORD_AUTH&quot;</span> <span class="st">&quot;ALLOW_REFRESH_TOKEN_AUTH&quot;</span> <span class="dt">\</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span> us-east-1 <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.UserPoolClient.ClientId&#39;</span><span class="va">)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the required values</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Discovery URL: https://cognito-idp.us-east-1.amazonaws.com/</span><span class="va">$POOL_ID</span><span class="st">/.well-known/openid-configuration&quot;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Client ID: </span><span class="va">$CLIENT_ID</span><span class="st">&quot;</span></span></code></pre></div>
<p>The deployment process uses these values with the
<code>agentcore configure</code> command:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> configure <span class="at">--name</span> mcp_simple_calculator <span class="at">--protocol</span> MCP <span class="at">--entrypoint</span> mcp_server.py</span></code></pre></div>
<p>During the guided setup, you provide:</p>
<ul>
<li><strong>Discovery URL</strong>: From the setup script output</li>
<li><strong>Client ID</strong>: From the setup script output</li>
</ul>
<p>Then deploy with:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> launch</span></code></pre></div>
<p><strong>This approach works for direct MCP server access</strong> -
you can connect to your deployed server using the the three parapeters
<code>machine_client_id</code>, <code>username</code> and
<code>password</code> to create a bearer token within a simple
script.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Getting Bearer token from Cognito using user credentials...&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ... get the ssm parameters</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get the bearer token</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> cognito_client.initiate_auth(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>   ClientId<span class="op">=</span>client_id,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>   AuthFlow<span class="op">=</span><span class="st">&#39;USER_PASSWORD_AUTH&#39;</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>   AuthParameters<span class="op">=</span>{</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>   <span class="st">&#39;USERNAME&#39;</span>: username,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>   <span class="st">&#39;PASSWORD&#39;</span>: password</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>I successfully tested this locally and retrieved information about
all available tools. However, this user-based authentication approach
has significant limitations and security concerns for production use. An
example output from the local testing script:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">leonvaness@MacBookPro</span> 03_blogpost_deploy_mcp % python blogpost_invoke_mcp_tools_userCred.py <span class="at">--name</span> blogpost_mcp_simple_calculator</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Getting</span> Bearer token from Cognito using user credentials...</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Retrieved</span> user credentials from SSM</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> username: ***REMOVED***</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Authenticating</span> user with Cognito...</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> obtained Bearer token using user authentication</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Testing</span> MCP Server: blogpost_mcp_simple_calculator</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> MCP Server ARN: arn:aws:bedrock-agentcore:eu-central-1:***REMOVED***:runtime/blogpost_mcp_simple_calculator-x6pZyqHgX0</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Pre-flight</span> Checks:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ex">==================================================</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Token</span> Info:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Issued</span> at: 2025-10-06 13:23:59</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Expires</span> at: 2025-10-06 14:23:59</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Current</span> time: 2025-10-06 13:23:59.758229</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Token</span> valid for 60.0 more minutes</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="ex">Connecting</span> to: https://bedrock-agentcore.eu-central-1.amazonaws.com/runtimes/arn%3Aaws%3Abedrock-agentcore%3Aeu-central-1%3A***REMOVED***%3Aruntime%2Fblogpost_mcp_simple_calculator-x6pZyqHgX0/invocations<span class="pp">?</span>qualifier=DEFAULT</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="ex">HTTP</span> connection established</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ex">MCP</span> ClientSession created</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Initializing</span> MCP session...</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="ex">MCP</span> session initialized with Bearer token authentication</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="ex">Listing</span> available tools...</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="ex">Available</span> MCP Tools:</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="ex">==================================================</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="ex">add_numbers</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Description:</span> Add two numbers together</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Parameters:</span> [<span class="st">&#39;a&#39;</span>, <span class="st">&#39;b&#39;</span>]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="ex">multiply_numbers</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Description:</span> Multiply two numbers together</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Parameters:</span> [<span class="st">&#39;a&#39;</span>, <span class="st">&#39;b&#39;</span>]</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="ex">greet_user</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Description:</span> Greet a user by name</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Parameters:</span> <span class="pp">[</span><span class="st">&#39;name&#39;</span><span class="pp">]</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> connected to MCP server!</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="ex">Found</span> 3 tools available.</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="ex">Testing</span> MCP Tools:</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="ex">==================================================</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="ex">Testing</span> add_numbers<span class="er">(</span><span class="ex">5,</span> 3<span class="kw">)</span><span class="ex">...</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Result:</span> 8</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="ex">Testing</span> multiply_numbers<span class="er">(</span><span class="ex">4,</span> 7<span class="kw">)</span><span class="ex">...</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Result:</span> 28</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="ex">Testing</span> greet_user<span class="er">(</span><span class="st">&#39;Alice&#39;</span><span class="kw">)</span><span class="ex">...</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Result:</span> Hello, Alice! Nice to meet you.</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="ex">MCP</span> tool testing completed!</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="ex">==================================================</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="ex">All</span> tools are working correctly!</span></code></pre></div>
<h2 id="the-authentication-challenge">The Authentication Challenge</h2>
<p>Now, let’s combine the two pieces into one working and production
ready system. The AWS documentation approach works perfectly for
<strong>direct MCP server access</strong> using a User Authentication,
but when I tried to create an <strong>agent that connects to an MCP
server</strong>, I had second thoughts about using user-base
authentication as I saw some issues:</p>
<ul>
<li><strong>Wrong authentication model</strong>: User authentication is
designed for humans, not services</li>
<li><strong>User account dependency</strong>: Service depends on a user
account that could be disabled or deleted</li>
<li><strong>Security concerns</strong>: Storing user credentials in for
example SSM or as a secret is not ideal for service-to-service
authentication</li>
<li><strong>Operational complexity</strong>: Requires managing user
accounts for services, which is unnecessary overhead</li>
</ul>
<p>I first learned about Agent authentication and integration through
the AgentCore Gateway in <a
href="https://www.youtube.com/watch?v=wzIQDPFQx30">this video</a>. In
here, they mask a Lambda behind an AgentCore Gateway to use it similar
to a MCP server. My initial thought was pretty clear: this should also
work with normal MCP servers.</p>
<p>Unfortunately, there were no real instructions on how to achieve
this. I took screenshots of their implementation, fed them to GenAI, and
together with this <a
href="https://opensearch.org/blog/hosting-opensearch-mcp-server-with-amazon-bedrock-agentcore/">OpenSearch
MCP Implementation</a>, I finally developed an agent that should connect
to my MCP calculator.</p>
<h2 id="the-solution-machine-to-machine-authentication">The Solution:
Machine-to-Machine Authentication</h2>
<p>For production use, <strong>Machine-to-Machine (M2M) authentication
is the recommended approach</strong>. Eventually, I found my way to this
<a
href="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/02-use-cases/customer-support-assistant">GitHub
Repository</a> - the actual code from the video I had watched! At least
in a very abstracted and extended way.</p>
<p>Crawling through the setup and configuration files that weren’t shown
in the video, I discovered that they used CloudFormation and a custom
script to create a specific Cognito User Pool with a Machine-to-Machine
(M2M) client.</p>
<p>While the official AWS documentation hints that MCP OAuth
authentication can happen with Cognito, it was nowhere explained that
<strong>Agent-to-MCP communication should use M2M
authentication</strong>, not user-based authentication.</p>
<h3 id="why-m2m-authentication-is-superior">Why M2M Authentication is
Superior:</h3>
<ol type="1">
<li><strong>Purpose-Built for Services</strong>: M2M is specifically
designed for application-to-application communication</li>
<li><strong>Better Security Model</strong>: Application-scoped
credentials with appropriate permissions</li>
<li><strong>No User Management</strong>: No need to create, manage, or
rotate user accounts</li>
<li><strong>More Reliable</strong>: No dependency on user accounts that
could be disabled</li>
<li><strong>Easier to Scale</strong>: One set of credentials per
service, not per user</li>
<li><strong>Industry Standard</strong>: This is how most production
services authenticate</li>
</ol>
<h2 id="the-complete-workflow">The Complete Workflow</h2>
<p>The workflow became clear:</p>
<h3
id="create-an-m2m-client-in-the-user-pool-and-store-required-information-in-ssm">1.
Create an M2M Client in the User Pool and Store Required Information in
SSM</h3>
<p>Here’s the key part of the Cognito setup for M2M authentication:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_cognito_user_pool(mcp_name):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Create Cognito User Pool with M2M client for agent-to-MCP communication.&quot;&quot;&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    cognito_client <span class="op">=</span> boto3.client(<span class="st">&#39;cognito-idp&#39;</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create User Pool</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    user_pool_response <span class="op">=</span> cognito_client.create_user_pool(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        PoolName<span class="op">=</span><span class="st">&#39;MCPAgentPool&#39;</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... basic pool configuration</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Resource Server (required for M2M client)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    resource_server_response <span class="op">=</span> cognito_client.create_resource_server(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        UserPoolId<span class="op">=</span>user_pool_id,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        Identifier<span class="op">=</span><span class="st">&#39;default-m2m-resource-server&#39;</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        Scopes<span class="op">=</span>[{<span class="st">&#39;ScopeName&#39;</span>: <span class="st">&#39;read&#39;</span>, <span class="st">&#39;ScopeDescription&#39;</span>: <span class="st">&#39;M2M access scope&#39;</span>}]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Machine-to-Machine App Client (the key difference!)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    machine_client_response <span class="op">=</span> cognito_client.create_user_pool_client(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        UserPoolId<span class="op">=</span>user_pool_id,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        ClientName<span class="op">=</span><span class="ss">f&#39;MCPAgentMachineClient-</span><span class="sc">{</span>mcp_name<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        GenerateSecret<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        AllowedOAuthFlows<span class="op">=</span>[<span class="st">&#39;client_credentials&#39;</span>],  <span class="co"># M2M flow, not user flow</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        AllowedOAuthScopes<span class="op">=</span>[<span class="st">&#39;default-m2m-resource-server/read&#39;</span>],</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        AllowedOAuthFlowsUserPoolClient<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... other M2M-specific settings</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store M2M credentials in SSM for agent access</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    ssm_client.put_parameter(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        Name<span class="op">=</span><span class="ss">f&#39;/app/mcp/</span><span class="sc">{</span>mcp_name<span class="sc">}</span><span class="ss">/machine_client_id&#39;</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        Value<span class="op">=</span>machine_client_id,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        Type<span class="op">=</span><span class="st">&#39;String&#39;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... store client secret and discovery URL</span></span></code></pre></div>
<p><strong>Key difference</strong>: This creates an <strong>M2M
client</strong> with <code>client_credentials</code> flow, not a user
client with <code>USER_PASSWORD_AUTH</code>.</p>
<h3
id="configure-your-agent-using-the-correct-discovery-id-and-client-id">2.
Configure Your Agent Using the Correct Discovery ID and Client ID</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up Cognito first</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> setup_M2M_cognito.py setup <span class="at">--mcp-name</span> mcp_simple_calculator</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure agent with MCP protocol</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> configure <span class="at">--name</span> mcp_simple_calculator <span class="at">--protocol</span> MCP <span class="at">--entrypoint</span> mcp_server.py</span></code></pre></div>
<p>During configuration, you’ll need:</p>
<ul>
<li><strong>Discovery URL</strong>:
<code>https://cognito-idp.{region}.amazonaws.com/{user_pool_id}/.well-known/openid-configuration</code></li>
<li><strong>Client ID</strong>: The Machine Client ID from step 1</li>
</ul>
<h3 id="launch-the-mcp-server">3. Launch the MCP Server</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> launch</span></code></pre></div>
<h3 id="write-the-agent-loading-correct-ssm-parameters-and-agent-arn">4.
Write the Agent (Loading Correct SSM Parameters and Agent ARN)</h3>
<p>Here’s the key part of the agent implementation that handles M2M
authentication:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_bearer_token(discovery_url: <span class="bu">str</span>, client_id: <span class="bu">str</span>, client_secret: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Get OAuth2 bearer token using M2M client credentials flow.&quot;&quot;&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get discovery data to find token endpoint</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(discovery_url)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    discovery_data <span class="op">=</span> response.json()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    token_endpoint <span class="op">=</span> discovery_data[<span class="st">&#39;token_endpoint&#39;</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M2M Client credentials flow (not user-based!)</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;grant_type&#39;</span>: <span class="st">&#39;client_credentials&#39;</span>,  <span class="co"># Key difference from user auth</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;client_id&#39;</span>: client_id,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;client_secret&#39;</span>: client_secret</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Content-Type&#39;</span>: <span class="st">&#39;application/x-www-form-urlencoded&#39;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.post(token_endpoint, data<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.json()[<span class="st">&#39;access_token&#39;</span>]</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_agent() <span class="op">-&gt;</span> Agent:</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Create agent with MCP tools using M2M authentication.&quot;&quot;&quot;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get M2M credentials from SSM (not user credentials)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    client_id <span class="op">=</span> get_ssm_parameter(<span class="st">&quot;/app/blogpost/mcp/mcp_simple_calculator/machine_client_id&quot;</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    client_secret <span class="op">=</span> get_ssm_parameter(<span class="st">&quot;/app/blogpost/mcp/mcp_simple_calculator/cognito_secret&quot;</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    discovery_url <span class="op">=</span> get_ssm_parameter(<span class="st">&quot;/app/blogpost/mcp/mcp_simple_calculator/cognito_discovery_url&quot;</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: M2M authentication requires client_secret, which user-based auth does not</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get M2M bearer token</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    bearer_token <span class="op">=</span> get_bearer_token(discovery_url, client_id, client_secret)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create MCP client with Bearer token authentication</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    mcp_client <span class="op">=</span> MCPClient(<span class="kw">lambda</span>: streamablehttp_client(mcp_url, {</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;authorization&quot;</span>: <span class="ss">f&quot;Bearer </span><span class="sc">{</span>bearer_token<span class="sc">}</span><span class="ss">&quot;</span>,  <span class="co"># M2M token, not user token</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Content-Type&quot;</span>: <span class="st">&quot;application/json&quot;</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rest of agent setup...</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agent</span></code></pre></div>
<p><strong>The difference in this agent</strong>: This uses
<code>client_credentials</code> grant type (M2M) instead of
<code>USER_PASSWORD_AUTH</code> (user-based authentication).</p>
<h3
id="configure-the-agent-no-cognito-required-cli-credentials-are-enough">5.
Configure the Agent (No Cognito Required, CLI Credentials Are
Enough)</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> configure <span class="at">-e</span> single_agent_mcp.py <span class="at">--protocol</span> HTTP <span class="at">-n</span> single_agent_mcp</span></code></pre></div>
<h3 id="launch-the-agent">6. Launch the Agent</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> launch</span></code></pre></div>
<h3 id="invoke-the-agent">7. Invoke the Agent</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with authentication</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">agentcore</span> invoke <span class="st">&quot;What is 2+2?&quot;</span></span></code></pre></div>
<p>Expected output:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">leonvaness@MacBookPro</span> 04_single_agent_mcp % agentcore invoke <span class="st">&quot;What is 2+2?&quot;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">+-----------------------------------</span> blogpost_single_agent_mcp <span class="at">-----------------------------------+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Session:</span> ca932e16-a0ab-442d-b53a-30dbbf782e28                                                    <span class="kw">|</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Request</span> ID: 0aba2764-abe0-4648-8b35-8a9371a2ece7                                                 <span class="kw">|</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">ARN:</span>                                                                                             <span class="kw">|</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">arn:aws:bedrock-agentcore:eu-central-1:***REMOVED***:runtime/blogpost_single_agent_mcp-PsKIjTAtVK</span> <span class="kw">|</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Logs:</span> aws logs tail /aws/bedrock-agentcore/runtimes/blogpost_single_agent_mcp-PsKIjTAtVK-DEFAULT <span class="kw">|</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">--log-stream-name-prefix</span> <span class="st">&quot;2025/10/08/[runtime-logs]&quot;</span> <span class="at">--follow</span>                                    <span class="kw">|</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="ex">aws</span> logs tail /aws/bedrock-agentcore/runtimes/blogpost_single_agent_mcp-PsKIjTAtVK-DEFAULT <span class="kw">|</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">--log-stream-name-prefix</span> <span class="st">&quot;2025/10/08/[runtime-logs]&quot;</span> <span class="at">--since</span> 1h                                  <span class="kw">|</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">GenAI</span> Dashboard:                                                                                 <span class="kw">|</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">https://console.aws.amazon.com/cloudwatch/home?region=eu-central-1#gen-ai-observability/agent-co</span> <span class="kw">|</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">re</span>                                                                                               <span class="kw">|</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="ex">+--------------------------------------------------------------------------------------------------+</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="ex">Response:</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> sum of 2 + 2 = 4.</span></code></pre></div>
<h2 id="key-insights">Key Insights</h2>
<p>The important takeaway is that <strong>Agent-to-MCP communication
requires Machine-to-Machine (M2M) OAuth2 authentication</strong>, not
user-based authentication. This involves:</p>
<ol type="1">
<li><strong>Cognito User Pool</strong> with a Resource Server</li>
<li><strong>M2M Client</strong> with <code>client_credentials</code>
flow</li>
<li><strong>OAuth2 Discovery</strong> for token endpoint resolution</li>
<li><strong>Bearer Token</strong> authentication for MCP server
access</li>
<li><strong>SSM Parameter Store</strong> for secure credential
management</li>
</ol>
<p>The workflow ensures that your agent can securely connect to MCP
servers deployed on AgentCore Runtime, enabling the integration of per
authentication and authorization.</p>
<h2 id="summary-and-recommendations">Summary and Recommendations</h2>
<h3 id="for-developmenttesting">For Development/Testing:</h3>
<ul>
<li><strong>User-based authentication</strong> works for simple testing
and development scenarios</li>
<li>Can be implemented quickly for proof-of-concept work</li>
<li>Suitable for local development and basic testing</li>
</ul>
<h3 id="for-production">For Production:</h3>
<ul>
<li><strong>Machine-to-Machine (M2M) authentication</strong> is the
recommended approach</li>
<li>Better security model with application-scoped credentials</li>
<li>More reliable and scalable for production environments</li>
<li>Follows industry best practices for service-to-service
authentication</li>
</ul>
<h3 id="key-takeaway">Key Takeaway:</h3>
<p>While user-based authentication works for basic MCP server access,
<strong>M2M authentication is the proper solution for production
agent-to-MCP communication</strong>. The M2M approach provides better
security, reliability, and scalability for your agent ecosystem.</p>
<h2 id="next-steps">Next Steps</h2>
<p>This pattern can be extended to support multiple MCP servers, each
with their own M2M client but sharing the same Cognito User Pool
infrastructure. The modular design allows for easy scaling and
maintenance of your agent ecosystem. Stay tuned for multiple MCPs, Agent
Memory and Observability.</p>
<pre><code></code></pre>
</body>
</html>
